<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DogCamp Hashtag & Page Insights Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Open Graph / Meta tags -->
  <meta property="og:type" content="website" />
  <meta property="og:title" content="DogCamp Hashtag & Page Insights Demo" />
  <meta property="og:description"
        content="Internal demo for DogCamp Airport Branch to test instagram_basic, Instagram Public Content Access, pages_show_list, and pages_read_engagement for our own business assets." />
  <meta property="og:url" content="https://seraphicboy.github.io/dogcamp-hashtag-demo/hashtag-demo.html" />
  <meta property="fb:app_id" content="1668676324517166" />

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
    }
    .page {
      max-width: 1100px;
      margin: 32px auto 48px;
      padding: 0 16px;
    }
    h1 {
      font-size: 24px;
      margin-bottom: 4px;
    }
    .subtitle {
      font-size: 13px;
      color: #9ca3af;
      margin-bottom: 16px;
    }
    .badge {
      display: inline-block;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: rgba(15,23,42,0.7);
      color: #9ca3af;
      margin-bottom: 8px;
    }
    .grid {
      display: grid;
      grid-template-columns: minmax(0, 1.3fr) minmax(0, 1fr);
      gap: 16px;
    }
    .card {
      background: #020617;
      border-radius: 18px;
      border: 1px solid #1f2937;
      padding: 16px 18px 18px;
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.8);
    }
    .card-title-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }
    .pill {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: 600;
      background: #020617;
    }
    .card-title {
      font-size: 16px;
      font-weight: 600;
    }
    .card-sub {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 10px;
    }
    label {
      display: block;
      font-size: 12px;
      color: #9ca3af;
      margin-top: 8px;
      margin-bottom: 4px;
    }
    input, textarea {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      font-size: 12px;
      font-family: inherit;
    }
    textarea {
      min-height: 60px;
      resize: vertical;
    }
    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
      margin-bottom: 8px;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid #1d4ed8;
      background: #1d4ed8;
      color: white;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      gap: 4px;
      white-space: nowrap;
    }
    .btn-secondary {
      border-color: #374151;
      background: transparent;
      color: #e5e7eb;
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: default;
    }
    .status {
      font-size: 12px;
      color: #9ca3af;
      white-space: pre-line;
    }
    .divider {
      height: 1px;
      background: #111827;
      border-radius: 999px;
      margin: 10px 0;
    }
    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
      font-size: 12px;
    }
    th, td {
      border-bottom: 1px solid #111827;
      padding: 6px 4px;
      text-align: left;
      vertical-align: top;
    }
    th {
      font-size: 11px;
      color: #9ca3af;
    }
    a {
      color: #38bdf8;
      text-decoration: none;
      word-break: break-all;
    }
    a:hover {
      text-decoration: underline;
    }
    .small-note {
      font-size: 11px;
      color: #6b7280;
      margin-top: 10px;
    }
    @media (max-width: 840px) {
      .grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="badge">INTERNAL DEMO · DOGCAMP AIRPORT BRANCH</div>
    <h1>Hashtag Search & Page Engagement Demo</h1>
    <div class="subtitle">
      This page demonstrates how we use:
      <span class="mono">instagram_basic</span>,
      <span class="mono">Instagram Public Content Access</span>,
      <span class="mono">pages_show_list</span>, and
      <span class="mono">pages_read_engagement</span>
      only for our own Business assets.
    </div>

    <div class="grid">
      <!-- LEFT: IG access token + hashtag search -->
      <div class="card">
        <div class="card-title-row">
          <div class="pill">IG</div>
          <div class="card-title">Step 0–2 · Instagram Business & Hashtags</div>
        </div>
        <div class="card-sub">
          This side shows how our internal app uses
          <span class="mono">instagram_basic</span> and
          <span class="mono">Instagram Public Content Access</span>.
          We only work with our own Instagram Business account
          <strong>@dogcamp.gochon</strong> and our own brand/event hashtags
          such as <span class="mono">도그캠프공항점</span>,
          <span class="mono">2023트리샷이벤트</span>,
          <span class="mono">2024트리샷이벤트</span> and
          <span class="mono">2025트리샷이벤트</span>.
          The purpose is to confirm event participation and optionally re-share
          some customer posts to our Stories, not to provide analytics for other
          businesses or to resell data.
        </div>

        <label for="access-token">Access Token (test environment)</label>
        <textarea id="access-token" placeholder="Paste a test access token that has instagram_basic, Instagram Public Content Access, pages_show_list and pages_read_engagement…"></textarea>

        <label for="ig-user-id">Instagram Business Account ID (ig_user_id)</label>
        <input id="ig-user-id" value="17841451651429958" />

        <label for="ig-hashtag">Brand / event hashtag (without #)</label>
        <input id="ig-hashtag" placeholder="예: 도그캠프공항점 또는 2025트리샷이벤트" />

        <div class="btn-row">
          <button class="btn" type="button" onclick="testIgBasic()">
            Step 1 · Test instagram_basic
          </button>
          <button class="btn btn-secondary" type="button" onclick="searchHashtag()">
            Step 2 · Hashtag Search (Public Content)
          </button>
        </div>

        <div id="ig-status" class="status">Waiting for access token…</div>

        <div class="divider"></div>

        <div class="status mono" id="ig-basic-output"></div>

        <div class="divider"></div>

        <div class="card-sub">
          Hashtag search results (public posts with our own brand/event hashtags):
        </div>
        <div id="hashtag-output" class="status"></div>

        <div class="small-note">
          In production, access tokens for our own Business assets are handled
          securely and used only server-to-server. For this review, we paste
          a test token here so you can see the full end-to-end behavior of
          Instagram Public Content Access with our own hashtags.
        </div>
      </div>

      <!-- RIGHT: Pages list + engagement -->
      <div class="card">
        <div class="card-title-row">
          <div class="pill">FB</div>
          <div class="card-title">Step 3–4 · Page List & Engagement</div>
        </div>
        <div class="card-sub">
          This side demonstrates how we use
          <span class="mono">pages_show_list</span> and
          <span class="mono">pages_read_engagement</span> only for our own
          Facebook Page (for example, the test Page
          <strong>“dogcamp gochon test”</strong>). We do not analyze or expose
          engagement for other businesses.
        </div>

        <label for="page-id">Facebook Page ID</label>
        <input id="page-id" value="905333672669646" />

        <div class="btn-row">
          <button class="btn" type="button" onclick="listPages()">
            Step 3 · List my Pages (pages_show_list)
          </button>
          <button class="btn btn-secondary" type="button" onclick="loadPagePosts()">
            Step 4 · Load Page Posts & Impressions
          </button>
        </div>

        <div id="page-status" class="status">
          Use a User or Page token that has pages_show_list and pages_read_engagement.
        </div>

        <div class="divider"></div>

        <div class="card-sub">
          Pages returned from <span class="mono">/me/accounts?fields=id,name</span>:
        </div>
        <div id="pages-output" class="status"></div>

        <div class="divider"></div>

        <div class="card-sub">
          Post impressions for the selected Page (using pages_read_engagement):
        </div>
        <div id="engagement-output" class="status"></div>

        <div class="small-note">
          We only read engagement for our own Page posts and display them in this
          internal dashboard. We do not sell, share, or use this data for ads or
          third-party analytics.
        </div>
      </div>
    </div>
  </div>

  <script>
    function getToken() {
      return (document.getElementById("access-token").value || "").trim();
    }

    function setStatus(id, msg) {
      var el = document.getElementById(id);
      if (el) el.textContent = msg;
    }

    // Step 1: instagram_basic – /{ig-user-id}?fields=id,username,media_count
    function testIgBasic() {
      const token = getToken();
      const igUserId = (document.getElementById("ig-user-id").value || "").trim();

      if (!token) {
        alert("Please paste an access token first.");
        return;
      }
      if (!igUserId) {
        alert("Please enter ig_user_id.");
        return;
      }

      setStatus("ig-status", "Calling /" + igUserId + "?fields=id,username,media_count with instagram_basic…");

      const url =
        "https://graph.facebook.com/v24.0/" +
        encodeURIComponent(igUserId) +
        "?fields=id,username,media_count&access_token=" +
        encodeURIComponent(token);

      fetch(url)
        .then(r => r.json())
        .then(data => {
          console.log("IG basic:", data);
          if (data.error) {
            setStatus("ig-status", "instagram_basic error:\n" + JSON.stringify(data.error, null, 2));
            document.getElementById("ig-basic-output").textContent = "";
            return;
          }
          document.getElementById("ig-basic-output").textContent =
            "id: " + data.id + "\n" +
            "username: " + data.username + "\n" +
            "media_count: " + data.media_count;
          setStatus("ig-status", "instagram_basic call succeeded.");
        })
        .catch(err => {
          console.error(err);
          setStatus("ig-status", "Error calling instagram_basic.");
          document.getElementById("ig-basic-output").textContent = "";
        });
    }

    // Step 2: Hashtag Search – Instagram Public Content Access
    async function searchHashtag() {
      const token = getToken();
      const igUserId = (document.getElementById("ig-user-id").value || "").trim();
      const hashtagText = (document.getElementById("ig-hashtag").value || "").trim();

      if (!token) {
        alert("Please paste an access token first.");
        return;
      }
      if (!igUserId) {
        alert("Please enter ig_user_id.");
        return;
      }
      if (!hashtagText) {
        alert("Please enter a hashtag text (without #).");
        return;
      }

      setStatus("ig-status",
        "Step 2: Searching hashtag \"" + hashtagText +
        "\" with Instagram Public Content Access…"
      );
      const outEl = document.getElementById("hashtag-output");
      outEl.textContent = "Loading…";

      try {
        // 1) Search hashtag ID
        const searchUrl =
          "https://graph.facebook.com/v24.0/ig_hashtag_search" +
          "?user_id=" + encodeURIComponent(igUserId) +
          "&q=" + encodeURIComponent(hashtagText) +
          "&access_token=" + encodeURIComponent(token);

        const searchRes = await fetch(searchUrl);
        const searchData = await searchRes.json();
        console.log("Hashtag search:", searchData);

        if (searchData.error || !searchData.data || !searchData.data.length) {
          outEl.textContent =
            "Error from hashtag search:\n" + JSON.stringify(searchData.error || searchData, null, 2);
          return;
        }

        const hashtagId = searchData.data[0].id;

        // 2) Load recent_media for that hashtag
        const mediaUrl =
          "https://graph.facebook.com/v24.0/" +
          encodeURIComponent(hashtagId) +
          "/recent_media" +
          "?user_id=" + encodeURIComponent(igUserId) +
          "&fields=id,caption,media_type,media_url,permalink,timestamp" +
          "&limit=10" +
          "&access_token=" + encodeURIComponent(token);

        const mediaRes = await fetch(mediaUrl);
        const mediaData = await mediaRes.json();
        console.log("Hashtag recent_media:", mediaData);

        if (mediaData.error) {
          outEl.textContent =
            "Error from recent_media:\n" + JSON.stringify(mediaData.error, null, 2);
          return;
        }

        const posts = mediaData.data || [];
        if (!posts.length) {
          outEl.textContent = "No public posts found for this hashtag.";
          return;
        }

        let html = "";
        html += "Hashtag ID: " + hashtagId + "\n";
        html += "Showing up to 10 public posts:\n\n";
        posts.forEach((p, idx) => {
          html += (idx + 1) + ") id: " + p.id + "\n";
          if (p.caption) {
            html += "   caption: " + p.caption.substring(0, 120) + (p.caption.length > 120 ? "…" : "") + "\n";
          }
          if (p.permalink) {
            html += "   permalink: " + p.permalink + "\n";
          }
          html += "   type: " + p.media_type + "\n";
          html += "   timestamp: " + p.timestamp + "\n\n";
        });

        outEl.textContent = html;
        setStatus("ig-status", "Hashtag search + recent_media succeeded.");
      } catch (err) {
        console.error(err);
        outEl.textContent = "Error running hashtag search.";
      }
    }

    // Step 3: pages_show_list – /me/accounts?fields=id,name
    function listPages() {
      const token = getToken();
      if (!token) {
        alert("Please paste an access token first.");
        return;
      }

      setStatus("page-status",
        "Calling /me/accounts?fields=id,name with pages_show_list…"
      );
      const outEl = document.getElementById("pages-output");
      outEl.textContent = "Loading…";

      const url =
        "https://graph.facebook.com/v24.0/me/accounts" +
        "?fields=id,name" +
        "&access_token=" + encodeURIComponent(token);

      fetch(url)
        .then(r => r.json())
        .then(data => {
          console.log("me/accounts:", data);
          if (data.error) {
            outEl.textContent =
              "Error reading pages:\n" + JSON.stringify(data.error, null, 2);
            return;
          }
          const pages = data.data || [];
          if (!pages.length) {
            outEl.textContent = "No Pages found for this token.";
            return;
          }

          let html = "Pages returned:\n\n";
          pages.forEach((p, idx) => {
            html += (idx + 1) + ") " + p.name + " (ID: " + p.id + ")\n";
          });

          outEl.textContent = html;

          // Set first page ID automatically
          if (pages[0].id) {
            document.getElementById("page-id").value = pages[0].id;
          }

          setStatus("page-status", "pages_show_list call succeeded.");
        })
        .catch(err => {
          console.error(err);
          outEl.textContent = "Error calling /me/accounts.";
        });
    }

    // Step 4: pages_read_engagement – /{page-id}/posts?fields=…insights.metric(post_impressions)
    async function loadPagePosts() {
      const token = getToken();
      const pageId = (document.getElementById("page-id").value || "").trim();

      if (!token) {
        alert("Please paste an access token first.");
        return;
      }
      if (!pageId) {
        alert("Please enter a Page ID (for example, 905333672669646).");
        return;
      }

      setStatus("page-status",
        "Step 4: Reading posts + post_impressions for Page ID " + pageId +
        " using pages_read_engagement…"
      );
      const outEl = document.getElementById("engagement-output");
      outEl.innerHTML = "Loading…";

      try {
        // 1) Page name
        const pageInfoUrl =
          "https://graph.facebook.com/v24.0/" +
          encodeURIComponent(pageId) +
          "?fields=name&access_token=" +
          encodeURIComponent(token);

        const pageInfoRes = await fetch(pageInfoUrl);
        const pageInfo = await pageInfoRes.json();
        console.log("Page info:", pageInfo);

        let pageName = pageInfo && pageInfo.name ? pageInfo.name : "(Unknown Page)";

        // 2) Posts + impressions
        const postsUrl =
          "https://graph.facebook.com/v24.0/" +
          encodeURIComponent(pageId) +
          "/posts" +
          "?fields=id,message,created_time,permalink_url," +
          "insights.metric(post_impressions).period(lifetime)" +
          "&limit=5" +
          "&access_token=" + encodeURIComponent(token);

        const postsRes = await fetch(postsUrl);
        const postsData = await postsRes.json();
        console.log("Page posts + insights:", postsData);

        if (postsData.error) {
          outEl.textContent =
            "Error reading posts:\n" + JSON.stringify(postsData.error, null, 2);
          return;
        }

        const posts = postsData.data || [];
        if (!posts.length) {
          outEl.textContent =
            "Page: " + pageName + " (ID: " + pageId + ")\nNo posts found.";
          return;
        }

        let html = "";
        html += "<div style='font-size:12px; margin-bottom:6px;'>Page: <strong>" +
          pageName + "</strong> (ID: " + pageId + ")</div>";
        html += "<table>";
        html += "<thead><tr>" +
          "<th>Post</th>" +
          "<th>Created time</th>" +
          "<th>Impressions<br/>(post_impressions)</th>" +
          "<th>Permalink</th>" +
          "</tr></thead><tbody>";

        posts.forEach(p => {
          let message = (p.message || "").substring(0, 80);
          if (p.message && p.message.length > 80) message += "…";

          let impressions = "–";
          if (p.insights && p.insights.data && p.insights.data.length) {
            const met = p.insights.data.find(m => m.name === "post_impressions");
            if (met && met.values && met.values.length) {
              impressions = met.values[0].value;
            }
          }

          html += "<tr>";
          html += "<td>" + (message || "(no message)") + "</td>";
          html += "<td>" + (p.created_time || "") + "</td>";
          html += "<td>" + impressions + "</td>";
          html += "<td>";
          if (p.permalink_url) {
            html += "<a href='" + p.permalink_url +
              "' target='_blank' rel='noreferrer'>Open post</a>";
          } else {
            html += "-";
          }
          html += "</td>";
          html += "</tr>";
        });

        html += "</tbody></table>";
        outEl.innerHTML = html;

        setStatus("page-status", "pages_read_engagement (post_impressions) call succeeded.");
      } catch (err) {
        console.error(err);
        outEl.textContent = "Error loading Page posts and engagement.";
      }
    }
  </script>
</body>
</html>
